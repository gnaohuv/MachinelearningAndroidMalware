from tkinter import Tk
from tkinter import filedialog
from androguard.core.apk import APK
import pandas as pd

PATH_DATA = "data.csv"


def apk_make(apk_path):
    def get_per(apk: APK):
        result = []
        for i in apk.get_permissions():
            i = i.split(".")
            result.append(i[-1])
        return list(set(result))

    apk = APK(apk_path)
    line = get_per(apk)
    result = {}
    for i in line:
        result[i] = 1

    def set_dict():
        df = pd.read_csv(PATH_DATA)
        line_dict = result

        for ele in range(len(line) - 1):
            line_dict[line[ele]] = 1
        line_dict["IS_MALICIOUS"] = line[-1]
        new_row_data = line_dict
        if all(key in new_row_data for key in df.columns):
            df = df.append(new_row_data, ignore_index=True)
        else:
            new_row_data_filled = {col: new_row_data.get(col, 0) for col in df.columns}
            df = df._append(new_row_data_filled, ignore_index=True)
        return df

    return set_dict()

def main():
    # Tạo một cửa sổ tkinter
    root = Tk()
    root.withdraw()  # Ẩn cửa sổ chính của tkinter

    # Hiển thị hộp thoại mở tệp và lấy đường dẫn của tệp APK đã chọn
    apk_path = filedialog.askopenfilename(filetypes=[("APK files", "*.apk")])

    # Đóng cửa sổ tkinter sau khi đã chọn tệp
    root.destroy()

    if apk_path:
        print("Đường dẫn tệp APK:", apk_path)
        # Gọi hàm xử lý tệp APK với đường dẫn tệp APK đã chọn
        result_df = apk_make(apk_path)
        print(result_df)  # In ra DataFrame sau khi xử lý tệp APK
    else:
        print("Không chọn tệp APK.")


if __name__ == "__main__":
    main()
